// srconfigs 0.4.2 - autoexec

// +============= IMPORTANT  NOTICE =============+
// | Unless you know what you're doing, DO NOT   |
// | MODIFY THIS FILE!                           |
// | Chances are, any config changes you're      |
// | trying to make should be done in extra.cfg, |
// | *not* here. Otherwise, easily updating      |
// | srconfigs without losing your changes will  |
// | become near-impossible. Check the README    |
// | for more details.                           |
// +=============================================+

// Load SAR
plugin_load sar

// Update SAR if needed
//sar_update release exit
sar_update pre exit

// Disable a weird HUD that can appear in demo playback
sar_disable_coop_score_hud 1

// Blacklist all commands from demo playback; they just cause issues
sar_demo_blacklist_all 1

// Stop the game from going to sleep when it loses focus
sar_disable_no_focus_sleep 1
cond "!game=reloaded" snd_mute_losefocus 0

// Allow OOB vision
r_portal_use_pvs_optimization 0

// Fix portal rendering
r_portal_fastpath 0

// Developer 1 settings; the actual developer mode is set in
// per-category configs
contimes 6
phys_penetration_error_time 0

// Helper alias for saveload binds
sar_function saveload "save $1; load $1"

// This alias is deprecated, but I'll keep it around for a bit for back
// compat. This is functionally equivalent as 'load' doesn't work in
// coop anyway
sar_alias do_load non_cm_only load

// Reloaded-specific commands
cond "game=reloaded" hud_saytext_time 0
cond "game=reloaded" alias +attack3     "ent_fire @caller Trigger"
cond "game=reloaded" alias -attack3     nop
cond "game=reloaded" alias +remote_view "ent_fire @toggle_ghosting Trigger"
cond "game=reloaded" alias -remote_view nop

// persistent svar defaults
sar_function __set_if_empty "sar_expand svar_set __tmp $'x$$$1$'; cond $'var:__tmp=x$' svar_set $1 $2"
sar_function __set_if_empty_persist "__set_if_empty $1 $2; svar_persist $1"
__set_if_empty_persist no_dialogue_toasts 0
__set_if_empty_persist no_dialogue_toasts_sp 0
__set_if_empty_persist no_dialogue_toasts_coop 0
__set_if_empty_persist show_blank_fades 1
__set_if_empty_persist coop_cm_enable_hud 0
__set_if_empty_persist coop_no_stopvideos 0
__set_if_empty_persist coop_no_remoteview 0
__set_if_empty_persist cm_attempt_counter 1
__set_if_empty_persist chapter_il_betsrighter 1
__set_if_empty_persist chapter_il_fly 1
__set_if_empty_persist useswap_invert 0
__set_if_empty_persist useswap_both 0
__set_if_empty_persist fullbright_amount 0.1
__set_if_empty_persist anypc_transition_time 0
__set_if_empty_persist demo_folder_name      "demos"
__set_if_empty_persist fullgame_demo_name    "%Y-%m-%d_%H-%M-%S/fullgame"
__set_if_empty_persist anypc_demo_name       "%Y-%m-%d_%H-%M-%S/anypc"
__set_if_empty_persist sp_cm_demo_name       "chapter$chapter/$map/$map"
__set_if_empty_persist amc_demo_name         "$role/%Y-%m-%d_%H-%M-%S/amc"
__set_if_empty_persist ac_demo_name          "$role/%Y-%m-%d_%H-%M-%S/ac"
__set_if_empty_persist coop_cm_demo_name     "$role/course$course/$map/$map"
__set_if_empty_persist il_demo_name          "chapter$chapter/$map/$map"
__set_if_empty_persist chapter_il_demo_name  "$role/$chapter_course/%Y-%m-%d_%H-%M-%S/$chapter_course"

// Always keep a backup of the last demo, just in case you accidentally
// overwrite something
sar_demo_overwrite_bak 1

// SAR HUD
sar_hud_order_bottom text
sar_hud_font_index 68
sar_hud_x 5
sar_hud_y 5
sar_hud_spacing 5
sar_hud_bg 1
sar_hud_velocity 3
sar_hud_position 2
sar_hud_angles 1
cond "!game=mel" sar_hud_demo 2
sar_toast_tag_set_color error FF3333

// We always want to be recording, so set this, even if the category
// uses autorecord
sar_record_at_demo_name ""
// HACKHACK: we don't record demos in Mel
cond "!game=mel" sar_record_at 0
// HACKHACK: really fucking cursed special case to mitigate inexplicable
// game crash
cond "!game=mel" sar_on_load cond  "map=mp_coop_wall_5" sar_record_at 120
cond "!game=mel" sar_on_load cond "!map=mp_coop_wall_5" sar_record_at 0

sar_function __choose "cond $'$1$' $2; cond $'!($1)$' $3"

// THE 'nop's IN ALIASES ARE IMPORTANT! They stop the keycode
// being carried across into the alias.

// Dialogue toggle
cond "!game=srm" sar_function snd_setdialogue "snd_setmixer potatosVO vol $1; snd_setmixer gladosVO vol $2; snd_setmixer announcerVO vol $3; snd_setmixer wheatleyVO vol $4; snd_setmixer caveVO vol $5; snd_setmixer coreVO vol $6; snd_disable_mixer_duck $7"
cond  "game=srm" sar_function snd_setdialogue "snd_disable_mixer_duck $7; puzzlemaker_play_sounds $8"
sar_alias +dialogue "sar_hud_set_text 0 Dialogue #55FF55ON;  sar_alias dialogue_toggle -dialogue; snd_setdialogue 0.4  0.7  0.7  0.7  0.88 0.75 0 1; nop"
sar_alias -dialogue "sar_hud_set_text 0 Dialogue #FF5555OFF; sar_alias dialogue_toggle +dialogue; snd_setdialogue 0.01 0.01 0.01 0.01 0.01 0.01 1 0; nop"
+dialogue
sar_hud_show_text 0
// In Speedrun Mod, puzzlemaker_play_sounds is overriden by config.cfg
// after this runs; toggle the dialogue twice after that to override it
cond "game=srm" sar_on_config_exec "dialogue_toggle; dialogue_toggle"

// Funneling toggle
sar_alias +funneling "sar_hud_set_text 1 Funneling #55FF55ON;  sar_alias funneling_toggle -funneling; sv_player_funnel_into_portals 1; nop"
sar_alias -funneling __choose "game=portal2 & (var:category=fullgame | var:category=anypc | var:category=amc | var:category=ac | var:category=chapter_il)" "__funneling_disallow" "__funneling_allow"
sar_alias __funneling_disallow  sar_toast_create error "Disabling 'sv_player_funnel_into_portals' is not allowed in fullgame or coop runs"
sar_alias __funneling_allow    "sar_hud_set_text 1 Funneling #FF5555OFF; sar_alias funneling_toggle +funneling; sv_player_funnel_into_portals 0"
+funneling
sar_hud_show_text 1

// Fullbright toggle
sar_function ambient_rgb "mat_ambient_light_r $1; mat_ambient_light_g $1; mat_ambient_light_b $1"
sar_function +fullbright "sar_hud_set_text 2 Fullbright #55FF55ON;  sar_alias fullbright_toggle -fullbright; ambient_rgb $fullbright_amount; nop"
sar_alias    -fullbright "sar_hud_set_text 2 Fullbright #FF5555OFF; sar_alias fullbright_toggle +fullbright; ambient_rgb 0.0; nop"
-fullbright
sar_hud_hide_text 2

// Sensitivity toggle
sar_alias    +lowsens "sar_hud_set_text 3 Sensitivity #FF5555LOW; svar_from_cvar old_sens sensitivity; sensitivity 0.01; sar_alias lowsens_toggle -lowsens; nop"
sar_function -lowsens "sar_hud_set_text 3 Sensitivity #55FF55NORMAL; sensitivity $old_sens; sar_alias lowsens_toggle +lowsens"
// Set old_sens right now, so that running -lowsens before a toggle
// doesn't break anything
svar_from_cvar old_sens sensitivity
-lowsens
sar_hud_hide_text 3

// Stop low sensitivity being saved in config.cfg
sar_on_exit "lowsens_toggle; -lowsens"

// Use-swap toggle
sar_function +useswap "sar_hud_set_text 4 Use-swap #55FF55ON;  svar_set __useswap 1; cond $'var:useswap_invert=1$' svar_set __useswap 0; sar_alias useswap_toggle -useswap"
sar_function -useswap "sar_hud_set_text 4 Use-swap #FF5555OFF; svar_set __useswap 0; cond $'var:useswap_invert=1$' svar_set __useswap 1; sar_alias useswap_toggle +useswap"
-useswap
sar_hud_hide_text 4

// Supershoot toggle
sar_alias +supershoot "sar_hud_set_text 5 Supershoot #55FF55ON;  svar_set __supershoot 1; sar_alias supershoot_toggle -supershoot; nop"
sar_alias -supershoot "sar_hud_set_text 5 Supershoot #FF5555OFF; svar_set __supershoot 0; sar_alias supershoot_toggle +supershoot; nop"
-supershoot
sar_hud_hide_text 5

// FPS toggle
sar_alias    +30fps "sar_hud_set_text 6 30FPS #55FF55ON; svar_from_cvar old_fps fps_max; fps_max 30; sar_alias 30fps_toggle -30fps; nop"
sar_function -30fps "sar_hud_set_text 6 30FPS #FF5555OFF; fps_max $old_fps; sar_alias 30fps_toggle +30fps"
sar_alias    30fps_toggle +30fps
// Set old_fps right now, so that running -30fps before a toggle
// doesn't break anything
svar_from_cvar old_fps fps_max
-30fps
sar_hud_hide_text 6

// Contimes toggle
sar_alias +contimes "sar_hud_set_text 7 Contimes #55FF55ON;  con_drawnotify 1; sar_alias contimes_toggle -contimes; nop"
sar_alias -contimes "sar_hud_set_text 7 Contimes #FF5555OFF; con_drawnotify 0; sar_alias contimes_toggle +contimes; nop"
-contimes
sar_hud_hide_text 7

// Mouse wheel bind aliases
sar_function +scrollup    __choose "var:__supershoot=1" "+attack $1" "+scrollup1 $1"
sar_function -scrollup    __choose "var:__supershoot=1" "-attack $1" "-scrollup1 $1"
sar_function +scrolldown  __choose "var:__supershoot=1" "+attack $1" "+scrolldown1 $1"
sar_function -scrolldown  __choose "var:__supershoot=1" "-attack $1" "-scrolldown1 $1"
sar_function +scrollup1   __choose "var:__useswap=1" "+use $1" "+jump $1"
sar_function -scrollup1   __choose "var:__useswap=1" "-use $1" "-jump $1"
sar_function +scrolldown1 __choose "var:__useswap=1 & var:useswap_both=1" "+use $1" "+jump $1"
sar_function -scrolldown1 __choose "var:__useswap=1 & var:useswap_both=1" "-use $1" "-jump $1"

// Toast settings
sar_toast_width 500
sar_toast_setpos bottom center

// Perform map detection, setting the appropriate svars
cond "game=portal2 | game=srm" sar_on_load exec map_detect/portal2
cond "game=aptag"              sar_on_load exec map_detect/aptag
cond "game=mel"                sar_on_load exec map_detect/mel
cond "game=reloaded"           sar_on_load exec map_detect/reloaded

// Black magic to create categories
sar_function __force_warn echo "Forcing category $1. Run 'auto' to re-enable automatic category selection."
svar_set __detect_len 0
sar_function __cat_loop     "svar_set __loopcmd $'$1$'; svar_set __loopi $2; __cat_loop_h1"
sar_function __cat_loop_h1  "cond $'!var:__loopi=0$' $'$__loopcmd; svar_sub __loopi 1; __cat_loop_h1$'"
sar_function __detect "svar_set __old_category $category; svar_set category $__detect_default; svar_set __detect_cur 0; __cat_loop $'sar_expand __detect_$$__detect_cur; svar_add __detect_cur 1$' $__detect_len; sar_expand cond $'!var:category=$$__old_category$' stop"
// HACKHACK: we don't record demos in Mel
cond "game=mel"  sar_alias __record nop
cond "!game=mel" sar_alias __record record ""
sar_function add_cat "sar_alias $1 $'stop; svar_set category $1; __force_warn $1; svar_set __force_cat 1; exec cats/$1; __record$'; sar_alias __detect_$__detect_len __detect_cat_$1; sar_alias __detect_cat_$1 nop; svar_add __detect_len 1"
sar_function detect_cat sar_alias __detect_cat_$1 cond "$2" svar_set category $1
sar_function default_cat svar_set __detect_default $1

// Category autoselection
sar_alias auto cond "var:__force_cat=1" "svar_set __force_cat 0; stop; __detect; sar_expand exec cats/$category; __record"
sar_on_load cond "!var:__force_cat=1" __detect

// Run category exec on load
sar_on_load sar_expand exec cats/$category

// Create the built-in categories
add_cat fullgame
cond "game=portal2" add_cat anypc
cond "game=portal2" add_cat sp_cm
cond "game=portal2" add_cat amc
cond "game=portal2" add_cat ac
cond "game=portal2" add_cat coop_cm
cond "game=mel | game=aptag | game=reloaded" add_cat il
cond "game=portal2 | game=srm | game=mel | game=aptag" add_cat chapter_il

// Add the auto-selection for all the built-in categories
default_cat fullgame
detect_cat fullgame "!cm & !coop & var:builtin_map=1"
cond "game=portal2" detect_cat sp_cm     "cm & !coop & var:builtin_map=1"
cond "game=portal2" detect_cat amc      "!cm &  coop & var:builtin_map=1"
cond "game=portal2" detect_cat coop_cm   "cm &  coop & var:builtin_map=1"

// Dialogue fade toasts
sar_toast_tag_set_duration fade forever
sar_on_load sar_toast_tag_dismiss_all fade
sar_on_load cond "game=portal2 & !var:no_dialogue_toasts=1 & !var:no_dialogue_toasts_coop=1 & (var:category=amc | var:category=ac | var:category=chapter_il)" exec dialogue_toasts/coop
sar_on_load cond "game=portal2 & !var:no_dialogue_toasts=1 & !var:no_dialogue_toasts_sp=1   & (var:category=fullgame | var:category=chapter_il)"              exec dialogue_toasts/sp

// CM attempt counter
sar_on_load svar_set __attempt_counter 0
sar_on_load cond "var:cm_attempt_counter=1 & (var:category=sp_cm | var:category=coop_cm)" svar_set __attempt_counter 1
sar_on_load cond "!(same_map & var:__attempt_counter=1)" svar_set __attempts 0
sar_on_load cond   "same_map & var:__attempt_counter=1"  svar_add __attempts 1
sar_on_load cond "!var:__attempt_counter=1" sar_hud_set_text 100 ""
sar_on_load cond  "var:__attempt_counter=1" sar_expand sar_hud_set_text 100 "Attempts: $__attempts"

// Show speedrun result after CM run
sar_on_flags cond "var:category=sp_cm | var:category=coop_cm" sar_speedrun_result

// We want to dispatch aliases to handle coop resetting where needed
// This general framework allows a) both players to run a command when
// the reset is run and b) a command to be run after both players finish
// resetting.
sar_function setup_coop_reset "sar_alias do_reset _coop_reset; sar_alias _coop_reset_both $'$1$'; sar_alias _coop_reset_done $'$2$'"
sar_alias _coop_reset "cond coop sar_coop_reset_progress; _coop_reset_both; cond !coop _coop_reset_done"
sar_on_coop_reset_remote _coop_reset_both
sar_on_coop_reset_done _coop_reset_done

// Category cond aliases for rule differences
sar_alias cm_only     cond  "var:category=sp_cm |  var:category=coop_cm"
sar_alias non_cm_only cond "!var:category=sp_cm & !var:category=coop_cm"

// Add the mtrigger categories and the sar_on_load execs
// We do this *after* running the category exec, so that no_mtriggers is set if
// necessary
cond "game=portal2" exec mtriggers/mtriggers

// Same for the chapter categories
sar_function run_cur_chapter "svar_set __cur_chapter $chapter; chapter_il"
sar_function run_chapter     "svar_set __cur_chapter $1; chapter_il"
cond "game=portal2 | game=srm" exec chapter_cats/portal2
cond "game=aptag"              exec chapter_cats/aptag
cond "game=mel"                exec chapter_cats/mel

sar_on_coop_spawn cond "!var:coop_no_remoteview=1" "+remote_view"

// When we open the game, assume we're running fullgame at first, just
// as a sane default
svar_set category fullgame
exec cats/fullgame

clear
echo "Using srconfigs v0.4.2"
sar_about
echo "" // Separate srconfigs output from other stuff
developer 0 // Stops console spew after autoexec

// Exec personal config
exec extra

// extra.cfg could have set useswap_invert
-useswap
